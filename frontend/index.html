<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VisionCheck</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="min-h-screen">
  <div class="max-w-5xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <header class="text-center mb-10">
      <p class="inline-flex items-center px-3 py-1 text-xs tracking-wide uppercase bg-gray-800 border border-gray-700 rounded-full text-gray-300">Computer Vision Playground</p>
      <h1 class="mt-4 text-3xl font-semibold text-white sm:text-4xl">VisionCheck</h1>
      <p class="mt-3 text-base text-gray-300 sm:text-lg">Capture a preview frame from the webcam and run three different models: object detection (YOLO), segmentation (SAM) and anomaly detection (Anomalib Padim).</p>
    </header>

    <main class="grid gap-6 md:grid-cols-2">
      <section class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg">
        <h2 class="text-xl font-semibold text-white">1 路 Preview</h2>
        <p class="mt-2 text-sm text-gray-300">Click "Grab preview" to see the live frame before running any model.</p>

        <div class="mt-4 flex flex-col items-center gap-4">
          <div class="w-full overflow-hidden rounded-xl border border-gray-700 bg-gray-900">
            <img id="previewImg" src="" alt="Webcam preview" class="hidden w-full object-cover" />
            <div id="previewPlaceholder" class="flex flex-col items-center justify-center py-16 text-gray-500 text-sm">
              <svg class="w-10 h-10 mb-3 text-gray-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.568 2.568M3.75 19.5h16.5A1.5 1.5 0 0021.75 18V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5z"></path></svg>
              Preview not captured yet
            </div>
          </div>

          <button id="previewBtn" class="w-full md:w-auto bg-indigo-500 hover:bg-indigo-400 text-white font-medium px-6 py-2 rounded-lg shadow-md transition disabled:opacity-60 disabled:cursor-not-allowed">Grab preview</button>
          <p id="previewStatus" class="hidden text-sm"></p>
        </div>
      </section>

      <section class="space-y-6">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg">
          <h2 class="text-xl font-semibold text-white">2 路 Pick a model</h2>
          <p class="mt-2 text-sm text-gray-300">Once the preview looks good, run the model you need. Each inference reuses the last captured frame.</p>
        </div>

        <article class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg" data-card="yolo">
          <header class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-white">YOLO v8</h3>
              <p class="text-sm text-gray-300">Real-time object detection with bounding boxes.</p>
            </div>
            <span class="text-xs font-semibold uppercase tracking-wide text-indigo-300">Detection</span>
          </header>
          <button data-model="yolo" class="mt-4 w-full bg-indigo-500 hover:bg-indigo-400 text-white font-medium px-4 py-2 rounded-lg transition disabled:opacity-60 disabled:cursor-not-allowed">Run YOLO</button>
          <p id="yoloStatus" class="mt-3 hidden text-sm"></p>
          <img id="yoloImg" src="" alt="YOLO result" class="mt-4 hidden w-full rounded-xl border border-gray-700" />
        </article>

        <article class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg" data-card="sam">
          <header class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-white">SAM</h3>
              <p class="text-sm text-gray-300">Automatic segmentation of the main regions in the frame.</p>
            </div>
            <span class="text-xs font-semibold uppercase tracking-wide text-emerald-300">Segmentation</span>
          </header>
          <button data-model="sam" class="mt-4 w-full bg-emerald-500 hover:bg-emerald-400 text-white font-medium px-4 py-2 rounded-lg transition disabled:opacity-60 disabled:cursor-not-allowed">Run SAM</button>
          <p id="samStatus" class="mt-3 hidden text-sm"></p>
          <img id="samImg" src="" alt="SAM result" class="mt-4 hidden w-full rounded-xl border border-gray-700" />
        </article>

        <article class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg" data-card="anomalib">
          <header class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-white">Anomalib Padim</h3>
              <p class="text-sm text-gray-300">Highlights areas that deviate from the "good" reference set.</p>
            </div>
            <span class="text-xs font-semibold uppercase tracking-wide text-pink-300">Anomaly</span>
          </header>
          <button data-model="anomalib" class="mt-4 w-full bg-pink-500 hover:bg-pink-400 text-white font-medium px-4 py-2 rounded-lg transition disabled:opacity-60 disabled:cursor-not-allowed">Run Anomalib</button>
          <p id="anomalibStatus" class="mt-3 hidden text-sm"></p>
          <img id="anomalibImg" src="" alt="Anomalib result" class="mt-4 hidden w-full rounded-xl border border-gray-700" />
        </article>
      </section>
    </main>

    <footer class="mt-10 text-center text-xs text-gray-400">
      VisionCheck 路 Flask + YOLO + SAM + Anomalib 路 Check backend logs for detailed diagnostics
    </footer>
  </div>

  <script>
    const previewBtn = document.getElementById('previewBtn');
    const previewImg = document.getElementById('previewImg');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const previewStatus = document.getElementById('previewStatus');

    const modelConfig = {
      yolo: {
        endpoint: '/api/yolo-snapshot',
        button: document.querySelector('[data-model="yolo"]'),
        status: document.getElementById('yoloStatus'),
        img: document.getElementById('yoloImg'),
        objectUrl: null,
      },
      sam: {
        endpoint: '/api/sam-snapshot',
        button: document.querySelector('[data-model="sam"]'),
        status: document.getElementById('samStatus'),
        img: document.getElementById('samImg'),
        objectUrl: null,
      },
      anomalib: {
        endpoint: '/api/anomalib_snapshot',
        button: document.querySelector('[data-model="anomalib"]'),
        status: document.getElementById('anomalibStatus'),
        img: document.getElementById('anomalibImg'),
        objectUrl: null,
      },
    };

    let previewObjectUrl = null;
    let previewAvailable = false;

    function setStatus(element, message, tone = 'info') {
      if (!element) return;
      element.textContent = message;
      element.classList.remove('hidden', 'text-gray-300', 'text-green-400', 'text-red-400');
      const toneClass = tone === 'success' ? 'text-green-400' : tone === 'error' ? 'text-red-400' : 'text-gray-300';
      element.classList.add(toneClass);
    }

    function resetStatus(element) {
      if (!element) return;
      element.classList.add('hidden');
    }

    async function fetchImage(url) {
      const response = await fetch(url, { cache: 'no-store' });
      if (!response.ok) {
        throw new Error(response.statusText || 'Request failed');
      }
      return response.blob();
    }

    function toggleButton(button, disabled) {
      if (!button) return;
      button.disabled = disabled;
    }

    previewBtn.addEventListener('click', async () => {
      toggleButton(previewBtn, true);
      setStatus(previewStatus, 'Capturing preview...', 'info');
      try {
        if (previewObjectUrl) {
          URL.revokeObjectURL(previewObjectUrl);
          previewObjectUrl = null;
        }
        const blob = await fetchImage(`/api/preview?ts=${Date.now()}`);
        previewObjectUrl = URL.createObjectURL(blob);
        previewImg.src = previewObjectUrl;
        previewImg.classList.remove('hidden');
        previewPlaceholder.classList.add('hidden');
        setStatus(previewStatus, 'Preview captured. Launch a model when ready.', 'success');
        previewAvailable = true;
      } catch (error) {
        setStatus(previewStatus, `Preview failed: ${error.message}`, 'error');
        previewAvailable = false;
      } finally {
        toggleButton(previewBtn, false);
      }
    });

    Object.entries(modelConfig).forEach(([key, config]) => {
      if (!config.button) return;

      config.button.addEventListener('click', async () => {
        if (!previewAvailable) {
          setStatus(previewStatus, 'Grab a preview first, then re-run the model.', 'error');
          previewBtn.focus();
          return;
        }

        resetStatus(config.status);
        toggleButton(config.button, true);
        setStatus(config.status, 'Running inference...', 'info');

        try {
          if (config.objectUrl) {
            URL.revokeObjectURL(config.objectUrl);
            config.objectUrl = null;
          }

          const blob = await fetchImage(`${config.endpoint}?use_last=true&ts=${Date.now()}`);
          config.objectUrl = URL.createObjectURL(blob);
          config.img.src = config.objectUrl;
          config.img.classList.remove('hidden');
          setStatus(config.status, 'Inference complete.', 'success');
        } catch (error) {
          setStatus(config.status, `Error: ${error.message}`, 'error');
        } finally {
          toggleButton(config.button, false);
        }
      });
    });
  </script>
</body>
</html>
